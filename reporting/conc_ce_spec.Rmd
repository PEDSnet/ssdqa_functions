---
title: 'Concordance: Clinical Events and Specialties'
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
tryCatch(source('../site/run.R'),
         error = function (e) message(e)) # May not be able to make db connection

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tidyr)
require(knitr)
require(kableExtra)
require(stringr)
require(tibble)
require(ggplot2)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
jspa_output_full<-results_tbl('conc_jspa_visit_cluster')%>%collect()
jspa_output_time<-results_tbl('conc_jspa_visit_cluster_time')%>%collect()
concept_names_grouped <- read.csv('../results/specialty_concept_names_named.csv')
```

## Single Site, Exploratory, No Time

### No stratification

Only showing top n=10 proportions. Can be adjusted by user

```{r}
output_ss_expl <- conc_output_gen(conc_process_output=jspa_output_full,
                                  conc_process_names=concept_names_grouped,
                                  single_site=TRUE,
                                  multi_site=FALSE,
                                  exploratory=TRUE,
                                  anomaly=FALSE,
                                  time_dimension=FALSE,
                                  facet_vars=c('codeset_name'),
                                  color_var='specialty_name',
                                  top_n = 10L)
output_ss_expl
```

### Stratified by visit type

Only shows top 5 per visit type, which could be different across visit types

```{r}
output_ss_expl_vis <- conc_output_gen(conc_process_output=jspa_output_full,
                                      conc_process_names=concept_names_grouped,
                                      single_site=TRUE,
                                      multi_site=FALSE,
                                      exploratory=TRUE,
                                      anomaly=FALSE,
                                      time_dimension=FALSE,
                                      facet_vars=c('codeset_name', 'visit_type'),
                                      color_var='specialty_name',
                                      top_n=5L)
output_ss_expl_vis
```

### Stratified by cluster

Only showing top 5 within each grouping, which could be different across clusters

```{r}
output_ss_expl_clus <- conc_output_gen(conc_process_output=jspa_output_full,
                                       conc_process_names=concept_names_grouped,
                                       single_site=TRUE,
                                       multi_site=FALSE,
                                       exploratory=TRUE,
                                       anomaly=FALSE,
                                       time_dimension=FALSE,
                                       facet_vars=c('codeset_name', 'cluster'),
                                       color_var='specialty_name',
                                       top_n=5L)
output_ss_expl_clus
```

## Single Site, Exploratory, Over Time

### No stratification

```{r}
output_ss_expl_ot <- conc_output_gen(conc_process_output=jspa_output_time,
                                         conc_process_names=concept_names_grouped,
                                         single_site=TRUE,
                                         multi_site=FALSE,
                                         exploratory=TRUE,
                                         anomaly=FALSE,
                                         time_dimension=TRUE,
                                         facet_vars=c('codeset_name'),
                                         color_var='specialty_name')
output_ss_expl_ot
```

### Stratified by Cluster

```{r}
output_ss_expl_ot <- conc_output_gen(conc_process_output=jspa_output_time,
                                         conc_process_names=concept_names_grouped,
                                         single_site=TRUE,
                                         multi_site=FALSE,
                                         exploratory=TRUE,
                                         anomaly=FALSE,
                                         time_dimension=TRUE,
                                         facet_vars=c('codeset_name', 'cluster'),
                                         color_var='specialty_name')
output_ss_expl_ot
```

## Single Site, Anomaly, No Time

If there is an anomalous specialty, only shows the top n specialties with the greatest difference from the mean for the given cluster. Here, only the top 10 are displayed.

```{r}
output_ss_an <- conc_output_gen(conc_process_output=jspa_output_full,
                                conc_process_names=concept_names_grouped,
                                single_site=TRUE,
                                multi_site=FALSE,
                                exploratory=FALSE,
                                anomaly=TRUE,
                                time_dimension=FALSE,
                                facet_vars=c('codeset_name'),
                                color_var='specialty_name',
                                top_n=10L)
output_ss_an
```

## Multi Site, Exploratory, No Time

```{r}
output_ms_exp_nt <- conc_output_gen(conc_process_output=jspa_output_full,
                                              conc_process_names=concept_names_grouped,
                                              single_site=FALSE,
                                              multi_site=TRUE,
                                              exploratory=TRUE,
                                              anomaly=FALSE,
                                              time_dimension=FALSE,
                                              facet_vars=c('codeset_name'),
                                              color_var='site')
output_ms_exp_nt
```

## Multi Site, Exploratory, No Time (Alternate Approach)

```{r}
output_ms_exp_nt2 <- conc_output_gen(conc_process_output=jspa_output_full,
                                              conc_process_names=concept_names_grouped,
                                              single_site=FALSE,
                                              multi_site=TRUE,
                                              exploratory=TRUE,
                                              anomaly=FALSE,
                                              time_dimension=FALSE,
                                              facet_vars=c('codeset_name'),
                                              color_var='site',
                                     alt=TRUE)
output_ms_exp_nt2
```

## Multi Site, Exploratory, Over Time

Only top 6, summed across all sites across all years, is shown. Can be adjusted by user.

```{r}
output_ms_exp_ot <- conc_output_gen(conc_process_output=jspa_output_time,
                                    conc_process_names=concept_names_grouped,
                                    single_site=FALSE,
                                    multi_site=TRUE,
                                    exploratory=TRUE,
                                    anomaly=FALSE,
                                    time_dimension=TRUE,
                                    facet_vars=c('codeset_name'),
                                    color_var='site',
                                    top_n=6L)
output_ms_exp_ot
```

## Multi-Site, Anomaly, No Time

Only specialties for which at least one site is an anomaly (+/- 2SD from mean) are pictured, but if there is an anomaly, all sites are displayed for that specialty

Error bars get huge when turn to a plotly plot

```{r eval=FALSE}
output_ms_an_nt <- conc_output_gen(conc_process_output=jspa_output_full,
                                   conc_process_names=concept_names_grouped,
                                              single_site=FALSE,
                                              multi_site=TRUE,
                                              exploratory=FALSE,
                                              anomaly=TRUE,
                                              time_dimension=FALSE,
                                              facet_vars=c('codeset_name'),
                                              color_var='site')
output_ms_an_nt
```