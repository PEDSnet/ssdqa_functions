---
title: 'Concordance: Clinical Events and Specialties'
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    fig_cap: TRUE
    df_print: paged
    toc: TRUE
    toc_depth: 5
    toc_collapsed: TRUE
    toc_float: TRUE
    number_sections: FALSE
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, 
  output_file = paste0('conc_ce_spec_', format(Sys.time(), '%Y%m%d'), '.html') )}) 
---

```{r setup, include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
tryCatch(source('../site/run.R'),
         error = function (e) message(e)) # May not be able to make db connection

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tidyr)
require(knitr)
require(kableExtra)
require(stringr)
require(tibble)
require(ggplot2)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
jspa_output_ss_nt<-results_tbl('cnc_sp_ss_nt')%>%collect()
jspa_output_ms_nt<-results_tbl('cnc_sp_ms_nt')%>%collect()
jspa_output_ss_at<-results_tbl('cnc_sp_ss_at')%>%collect()
jspa_output_ms_at<-results_tbl('cnc_sp_ms_at')%>%collect()

concept_names_grouped <- read.csv('../results/specialty_concept_names_named.csv')
```

## cnc_sp_ss_exp_nt (Single Site, Exploratory, No Time)

### No stratification

  - Only showing top 10 most frequently visited proportions. Can be adjusted by user

```{r}
output_ss_expl <- conc_output_gen(conc_process_output=jspa_output_ss_nt,
                                  conc_process_names=concept_names_grouped,
                                  single_site=TRUE,
                                  multi_site=FALSE,
                                  exploratory=TRUE,
                                  anomaly=FALSE,
                                  time_dimension=FALSE,
                                  facet_vars=c('codeset_name'),
                                  color_var='specialty_name',
                                  top_n = 10L)
output_ss_expl
```

### Stratified by visit type

  - Only shows top 5 per visit type, which could be different across visit types
  - Filtered to only emergency_dept, outpatient, inpatient

```{r}
jspa_output_edopip <- jspa_output_ss_nt %>%
  filter(visit_type%in%c('emergency_dept', 'outpatient', 'inpatient'))
output_ss_expl_vis <- conc_output_gen(conc_process_output=jspa_output_edopip,
                                      conc_process_names=concept_names_grouped,
                                      single_site=TRUE,
                                      multi_site=FALSE,
                                      exploratory=TRUE,
                                      anomaly=FALSE,
                                      time_dimension=FALSE,
                                      facet_vars=c('codeset_name', 'visit_type'),
                                      color_var='specialty_name',
                                      top_n=5L)
output_ss_expl_vis
```

### Stratified by cluster

  - Only showing top 5 within each grouping, which could be different across clusters

```{r}
output_ss_expl_clus <- conc_output_gen(conc_process_output=jspa_output_ss_nt,
                                       conc_process_names=concept_names_grouped,
                                       single_site=TRUE,
                                       multi_site=FALSE,
                                       exploratory=TRUE,
                                       anomaly=FALSE,
                                       time_dimension=FALSE,
                                       facet_vars=c('codeset_name', 'cluster'),
                                       color_var='specialty_name',
                                       top_n=5L)
output_ss_expl_clus
```

## cnc_sp_ss_exp_at (Single Site, Exploratory, Over Time)

### No stratification

```{r}
output_ss_expl_at <- conc_output_gen(conc_process_output=jspa_output_ss_at,
                                         conc_process_names=concept_names_grouped,
                                         single_site=TRUE,
                                         multi_site=FALSE,
                                         exploratory=TRUE,
                                         anomaly=FALSE,
                                         time_dimension=TRUE,
                                         facet_vars=c('codeset_name'),
                                         color_var='specialty_name')
output_ss_expl_at
```

### Stratified by Cluster

```{r}
output_ss_expl_at <- conc_output_gen(conc_process_output=jspa_output_ss_at,
                                         conc_process_names=concept_names_grouped,
                                         single_site=TRUE,
                                         multi_site=FALSE,
                                         exploratory=TRUE,
                                         anomaly=FALSE,
                                         time_dimension=TRUE,
                                         facet_vars=c('codeset_name', 'cluster'),
                                         color_var='specialty_name')
output_ss_expl_at
```

## cnc_sp_ss_an_nt (Single Site, Anomaly, No Time)

  - A specialty is anomalous if its proportion of visits for the given cluster is +/- the specified number of MAD from the median proportion of visits for that specialty across all other clusters
  - Anomalous specialties for the cluster are stars, non-anomalous are points
  - Size is based on number of MAD from the median
  - Fill color is based on proportion of 
  - Specialties without any visits for the cluster do not have a point (is this okay or should we be counting this as a zero and including in the computation of the median?)

```{r}
output_ss_an <- conc_output_gen(conc_process_output=jspa_output_ss_nt,
                                conc_process_names=concept_names_grouped,
                                single_site=TRUE,
                                multi_site=FALSE,
                                exploratory=FALSE,
                                anomaly=TRUE,
                                time_dimension=FALSE,
                                facet_vars=c('codeset_name'),
                                color_var='specialty_name',
                                n_mad=3)
output_ss_an
```

## cnc_sp_ss_an_at (Single Site, Anomaly, Over Time)

  - Lots of plots if do cluster x specialty
  - Could still do cluster x specialty, but only show them if: 
      - Above a certain number of visits?
      - x% of the years are anomolous? (not sure how we'd implement this without doing computation outside of the qi chart code)

```{r fig.width=10, fig.height=10}
output_ss_an_at <- conc_output_gen(conc_process_output=jspa_output_ss_at,
                                conc_process_names=concept_names_grouped,
                                single_site=TRUE,
                                multi_site=FALSE,
                                exploratory=FALSE,
                                anomaly=TRUE,
                                time_dimension=TRUE,
                                facet_vars=c('codeset_name'),
                                color_var='specialty_name')
output_ss_an_at
```


## cnc_sp_ms_exp_nt (Multi Site, Exploratory, No Time)

```{r}
output_ms_exp_nt <- conc_output_gen(conc_process_output=jspa_output_ms_nt,
                                              conc_process_names=concept_names_grouped,
                                              single_site=FALSE,
                                              multi_site=TRUE,
                                              exploratory=TRUE,
                                              anomaly=FALSE,
                                              time_dimension=FALSE,
                                              facet_vars=c('codeset_name'),
                                              color_var='site')
output_ms_exp_nt
```

## cnc_sp_ms_exp_at (Multi Site, Exploratory, Over Time)

Only top 6, summed across all sites across all years, is shown. Can be adjusted by user.

```{r}
output_ms_exp_ot <- conc_output_gen(conc_process_output=jspa_output_ms_at,
                                    conc_process_names=concept_names_grouped,
                                    single_site=FALSE,
                                    multi_site=TRUE,
                                    exploratory=TRUE,
                                    anomaly=FALSE,
                                    time_dimension=TRUE,
                                    facet_vars=c('codeset_name'),
                                    color_var='site',
                                    top_n=6L)
output_ms_exp_ot
```

## cnc_sp_ms_an_nt (Multi-Site, Anomaly, No Time)

The median proportion of visits with each specialty across sites is computed, and each site's proportion of visits with that specialty is compared against the median using n_mad = (absolute distance to the median)/(median absolute distance from the median)

  - Anomalous (more than +/- the specified MAD) specialties are stars, non-anomalous specialties are points
  - Size is based on number of MAD from median
  - Color is based on proportion of visits with the given specialty
  - Specialties are only shown if there is at least one site with an anomalous proportion
  - Sites without any visits to the specialty do not have a point
  

```{r}
concept_names_nona<-concept_names_grouped%>%filter(!specialty_name%in%c('Unknown','Other'))
output_ms_an_nt <- conc_output_gen(conc_process_output=jspa_output_ms_nt,
                                   conc_process_names=concept_names_grouped,
                                   single_site=FALSE,
                                   multi_site=TRUE,
                                   exploratory=FALSE,
                                   anomaly=TRUE,
                                   time_dimension=FALSE,
                                   facet_vars=c('codeset_name'),
                                   color_var='site',
                                   n_mad=3L,
                                   alt=TRUE)


output_ms_an_nt
```

## cnc_sp_ms_an_at (Multi-Site, Anomaly, Across Time)

MAD is computed for each specialty for each year, and each site is compared to the median for that specialty for the given year.

We could give the option to limit to only show "top n", but would need to figure out what that means in this context: specialties where there is the largest n_mad in one of the years, regardless of the year? something else?

```{r}
output_ms_an_ot <- conc_output_gen(conc_process_output=jspa_output_ms_at,
                                   conc_process_names=concept_names_grouped,
                                   single_site=FALSE,
                                   multi_site=TRUE,
                                   exploratory=FALSE,
                                   anomaly=TRUE,
                                   time_dimension=TRUE,
                                   facet_vars=c('codeset_name'))

output_ms_an_ot
```
