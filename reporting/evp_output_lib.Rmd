---
title: "Expected Variables Present Output Library"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_collapsed: yes
    toc_float: yes
---

```{r setup, include=FALSE}
# Default taken from R notebook behavior: when knitting, wd will always be location of notebook
base_dir <- '..'
Sys.setenv(PEDSNET_SKIP_REQUEST_EXECUTION=1)
tryCatch(source('../site/run.R'),
         error = function (e) message(e)) # May not be able to make db connection

# Set to "local" to read data from ../results, or another value to read from db
data_source <- if_else(config('execution_mode') == 'distribution', 'local', 'not_local')

require(tidyr)
require(knitr)
require(kableExtra)
require(stringr)
require(tibble)
require(ggplot2)
require(qicharts2)

get_results <- function(tbl_name) {
  if (data_source == 'local') {
    rslt <- read_csv(paste0('../results/', tbl_name, '.csv'))
  }
  else {
    rslt <- results_tbl(tbl_name) %>% collect()
  }
rslt
}

prettify_kable <- function(data) {
  data %>% kable(digits = 4, format.args = list(big.mark = ',')) %>%
    kable_styling(bootstrap_options = c("striped", "hover")) %>%
    column_spec(1, bold = T, border_right = T)
}

no_time <- read_csv(file = paste0(config('base_dir'), '/results/ecp_nt.csv'))

across_time <- read_csv(file = paste0(config('base_dir'), '/results/ecp_at.csv'))

facet <- NULL

output_level <- 'patient'

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

```

This report is a library of each distinct output available for the Expected Variables Present (EVP) check. The output below was computed at the most basic level (i.e. without any additional facets). Certain customizations may be made by the user should they desire them.

## Single Site, Exploratory, No Time

This output summarizes the proportion of patients that meet the criteria for a given variable / concept group at a given site.

```{r ss_exp_nt}

evp_ss_exp_nt(process_output = no_time %>% filter(site == 'nationwide'),
              output_level = output_level,
              facet = facet)

```

## Multi Site, Exploratory, No Time

This heatmap summarizes the proportion of patients at each site that meet the criteria for a given variable / concept group

```{r ms_exp_nt}

evp_ms_exp_nt(process_output = no_time,
              output_level = output_level,
              facet = facet)

```

## Single Site, Anomaly, No Time

This heatmap displays the Jaccard similarity index between concept groups. A high similarity index indicates the concept groups co-occur (i.e. exist within the same patient's record) frequently.

```{r ss_anom_nt}

ss_anom <- evp_process(cohort = results_tbl('jspa_cohort'),
                       #site_list = c('chop'),
                       multi_or_single_site = 'single',
                       anomaly_or_exploratory = 'anomaly')

g <- evp_ss_anom_nt(process_output = ss_anom,
                    facet = 'grp')

g

```

## Multi Site, Anomaly, No Time

This check performs a K-means cluster analysis to identify which site has a "profile" of represented concepts that may be very different from the rest. When a facet is included, one graph is produced per group as facetting is not native to the K-means graph type.

```{r ms_anom_nt}

evp_ms_anom_nt(process_output = no_time,
               output_level = output_level,
               facet = facet)

```

## Single Site, Exploratory, Across Time

This line graph displays the proportion of patients belonging to a given variable / concept group across a user provided time span.

```{r ss_exp_at}

g <- evp_ss_exp_at(process_output = across_time %>% filter(site == 'nationwide'),
              output_level = output_level,
              facet = facet)

g

```

## Multi Site, Exploratory, Across Time

This line graph displays the proportion of patients belonging to a given variable / concept group within each site across a user provided time span.

```{r ms_exp_at}

g <- evp_ms_exp_at(process_output = across_time,
              output_level = output_level,
              facet = facet)

g
```

## Single Site, Anomaly, Across Time

This check outputs a control chart that highlights anomalies in the proportion of patients per variable / concept group. Blue dots along the line indicate non-anomalous values, while orange dots are anomalies.

```{r ss_anom_at}

evp_ss_anom_at(process_output = across_time %>% filter(site == 'nationwide'),
              output_level = output_level,
              facet = facet)

```

## Multi Site, Anomaly, Across Time

This heat map shows the proportion of "unstable" concept groups across time. The check will look for concept groups that fall a certain number of MAD (provided by the user) away from the all site median throughout the user specified time span. The "instability" of the concept is represented by both the number and proportion of outliers within a given site + concept group pair.

```{r ms_anom_at}

evp_ms_anom_at(process_output = across_time,
               output_level = output_level,
               facet = facet,
               mad_dev = 1)

```